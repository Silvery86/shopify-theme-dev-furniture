{% comment %}
  Section: All Products with sorting and "Load More" button lazy loading
{% endcomment %}

{% assign sorted_products = collection.products %}

{%- case section.settings.product_sort_by -%}
  {%- when 'price_low_to_high' -%}
    {% assign sorted_products = collection.products | sort: 'price' %}
  {%- when 'price_high_to_low' -%}
    {% assign sorted_products = collection.products | sort: 'price' | reverse %}
  {%- when 'newest' -%}
    {% assign sorted_products = collection.products | sort: 'created_at' | reverse %}
  {%- else -%}
    {%- assign sorted_products = collection.products -%}
{%- endcase -%}

{% assign products_per_row = section.settings.products_per_row | default: 4 %}

{%- assign remaining_products = '' -%}
{%- for product in sorted_products offset: products_per_row -%}
  {%- assign remaining_products = remaining_products | append: product.handle -%}
  {%- unless forloop.last -%}
    {%- assign remaining_products = remaining_products | append: ',' -%}
  {%- endunless -%}
{%- endfor -%}

<div class="page-width" id="{{ section.id }}"> 
  <custom-products-grid
    data-remaining-products="{{ remaining_products }}"
    data-products-per-row="{{ products_per_row }}"
  >
    <div
      class="products-grid"
      style="--item-per-row: {{ products_per_row }}"
    >
      {%- for product in sorted_products limit: products_per_row -%}
        {% render "custom-product-card", product: product %}
      {%- endfor -%}
    </div>

    {% if remaining_products != '' %}
      <button class="button load-more-button">Load More</button>
    {% endif %}
  </custom-products-grid>
</div>

<style>
  custom-products-grid {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    padding: 20px 0;
  }

  custom-products-grid .products-grid {
    width: 100%;
    display: grid;
    grid-template-columns: repeat(var(--item-per-row), 1fr);
    gap: 16px;
  }

  button.load-more-button {
    background-color: #000;
    color: #fff;
    border: none;
    padding: 12px 32px;
    font-size: 16px;
    cursor: pointer;
    border-radius: 6px;
    transition: background-color 0.3s ease;
  }

  button.load-more-button:hover:not(:disabled) {
    background-color: #222;
  }

  button.load-more-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
</style>

<script>
  class customProductsGrid extends HTMLElement {
    index = 0;
    constructor() {
        super();
        this.loadMoreButton = this.querySelector('.load-more-button');
        this.productsPerRow = Number.parseInt(this.dataset.productsPerRow);
        this.remainingProducts = this.dataset.remainingProducts.split(',');
        this.grid = this.querySelector('.products-grid');         
        this.loadMoreButton.addEventListener('click', this.loadMoreProducts.bind(this));
    }

    async loadMoreProducts() {
        this.loadMoreButton.setAttribute('disabled', 'true');
        const productsToLoad = this.remainingProducts.slice(this.index, this.index + this.productsPerRow);
       
        const products = await Promise.all(
            productsToLoad.map(async (productHandle) => {
                console.log(productHandle);
                const response = await fetch(`/products/${productHandle}?sections=custom-product-card`);
              
                const data = await response.json();
                  console.log(response);
                return data['custom-product-card'];
            })
        );

        products.forEach((product) => {
            this.grid.innerHTML += product;
        });

        this.index += this.productsPerRow;

        if (this.index >= this.remainingProducts.length) {
            this.loadMoreButton.remove();
        } else {
            this.loadMoreButton.removeAttribute('disabled');
        }
    }
}
customElements.define('custom-products-grid', customProductsGrid);
</script>

{% schema %}
{
  "name": "Custom Products Grid",
  "settings": [
    {
      "type": "range",
      "id": "products_per_row",
      "label": "Products Per Row",
      "default": 4,
      "min": 1,
      "max": 6
    },
    {
      "type": "select",
      "id": "product_sort_by",
      "label": "Sort Products By",
      "default": "price_low_to_high",
      "options": [
        { "value": "best_selling", "label": "Best Selling (default)" },
        { "value": "newest", "label": "Newest" },
        { "value": "sale_percent", "label": "Sale Percent" },
        { "value": "sold_number", "label": "Sold Number" },
        { "value": "price_low_to_high", "label": "Price, Low to High" },
        { "value": "price_high_to_low", "label": "Price, High to Low" }
      ]
    }
  ],
  "presets": [
    {
      "name": "Custom Products Grid"
    }
  ]
}
{% endschema %}
